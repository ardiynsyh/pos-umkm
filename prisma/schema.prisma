// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  nama      String
  email     String   @unique
  password  String
  role      UserRole @default(KASIR)
  outletId  String?
  outlet    Outlet?  @relation(fields: [outletId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  KASIR
  MANAGER
}

model Outlet {
  id           String        @id @default(cuid())
  nama         String
  alamat       String?
  telepon      String?
  users        User[]
  products     Product[]
  transactions Transaction[]
  tables       Table[]       // ← TAMBAH INI
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("outlets")
}

model Category {
  id        String    @id @default(cuid())
  nama      String
  deskripsi String?
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("categories")
}

model Product {
  id               String            @id @default(cuid())
  sku              String            @unique
  barcode          String?           @unique
  nama             String
  deskripsi        String?
  categoryId       String
  category         Category          @relation(fields: [categoryId], references: [id])
  hargaBeli        Float             @default(0)
  hargaJual        Float
  stok             Int               @default(0)
  stokMinimal      Int               @default(5)
  satuan           String            @default("pcs")
  foto             String?
  outletId         String
  outlet           Outlet            @relation(fields: [outletId], references: [id])
  transactionItems TransactionItem[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([barcode])
  @@index([sku])
  @@map("products")
}

model Transaction {
  id               String            @id @default(cuid())
  nomorTransaksi   String            @unique
  total            Float
  diskon           Float             @default(0)
  pajak            Float             @default(0)
  totalBayar       Float
  uangDibayar      Float
  kembalian        Float
  metodePembayaran PaymentMethod     @default(TUNAI)
  status           TransactionStatus @default(BERHASIL)
  kasir            String?
  pelanggan        String?
  catatan          String?
  outletId         String
  outlet           Outlet            @relation(fields: [outletId], references: [id])
  items            TransactionItem[]
  isSynced         Boolean           @default(true)
  syncedAt         DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([nomorTransaksi])
  @@index([createdAt])
  @@map("transactions")
}

enum PaymentMethod {
  TUNAI
  DEBIT
  KREDIT
  QRIS
  TRANSFER
}

enum TransactionStatus {
  BERHASIL
  TERTUNDA
  DIBATALKAN
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  namaProduk    String
  quantity      Int
  hargaSatuan   Float
  subtotal      Float
  createdAt     DateTime    @default(now())

  @@map("transaction_items")
}

// ─────────────────────────────────────────────────────────────────────────────
// TAMBAHKAN model-model ini ke dalam prisma/schema.prisma yang sudah ada
// Jangan hapus model yang sudah ada sebelumnya!
// ─────────────────────────────────────────────────────────────────────────────

model Table {
  id        String   @id @default(cuid())
  number    Int      @unique
  label     String
  isActive  Boolean  @default(true)
  outletId  String                                                    // ← TAMBAH INI
  outlet    Outlet   @relation(fields: [outletId], references: [id]) // ← TAMBAH INI
  orders    Order[]
  createdAt DateTime @default(now())
}

model Order {
  id          String      @id @default(cuid())
  orderNumber String      @unique // e.g. "ORD-001"
  tableId     String
  table       Table       @relation(fields: [tableId], references: [id])
  customerName String?
  status      OrderStatus @default(PENDING)
  paymentStatus PaymentStatus @default(UNPAID)
  paymentMethod String?       // "midtrans", "cash"
  midtransToken String?       // snap token dari midtrans
  midtransOrderId String?     @unique
  totalAmount Float
  items       OrderItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  productName String  // simpan nama saat order (antisipasi produk dihapus)
  price     Float
  quantity  Int
  subtotal  Float
}

enum OrderStatus {
  PENDING      // baru masuk, belum diproses
  PROCESSING   // sedang diproses dapur/kasir
  READY        // siap disajikan
  COMPLETED    // selesai
  CANCELLED    // dibatalkan
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

model Pengeluaran {
  id         String   @id @default(cuid())
  tanggal    DateTime
  kategori   String
  keterangan String
  jumlah     Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("pengeluaran")
}

model paymentQR {
  id            Int      @id @default(autoincrement())
  provider      String
  qrCode        String
  accountNumber String
  accountName   String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
}